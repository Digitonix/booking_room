<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Management Users
    </title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Gaya khusus untuk panah dropdown select */
        .custom-select-arrow {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'%3e%3c/path%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }

        /* Gaya untuk input yang tidak valid */
        .form-input.is-invalid {
            border-color: #ef4444 !important; /* red-500 */
        }

        /* Transisi untuk modal */
        .modal {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
        
        /* --- Gaya CSS untuk Mobile Card View --- */
        @media (max-width: 768px) {
            .table-mobile-card thead {
                display: none;
            }

            .table-mobile-card tr {
                display: block;
                margin-bottom: 1rem;
                border-radius: 0.75rem;
                overflow: hidden;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                transition: transform 0.2s ease-in-out;
            }

            .table-mobile-card tr:hover {
                transform: translateY(-0.25rem);
            }
            
            .table-mobile-card td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 1rem;
                border-bottom: 1px solid #e5e7eb;
                gap: 0.5rem;
            }

            .table-mobile-card td:last-child {
                border-bottom: none;
            }
            
            .table-mobile-card td:before {
                content: attr(data-label);
                font-weight: 600;
                color: #4b5563; /* gray-600 */
            }
            
            /* Menyesuaikan layout tombol aksi pada mobile */
            .table-mobile-card .actions-cell .flex {
                flex-direction: row;
                justify-content: flex-end;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="container mx-auto px-4 py-8 md:py-12 max-w-6xl">
    <div class="bg-white/80 backdrop-blur-md rounded-3xl shadow-2xl p-6 md:p-10 lg:p-12 mb-8">
        
        <div class="flex items-center justify-between mb-6 gap-4 flex-wrap">
            <h2 class="text-indigo-600 font-bold text-3xl md:text-4xl">
                <i class="fas fa-users-cog mr-3"></i>Management Users
            </h2>
            <div class="flex flex-col sm:flex-row gap-4 w-full sm:w-auto">
                <a href="{{ url_for('home') }}" class="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-full font-semibold transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg flex items-center justify-center">
                    <i class="fas fa-arrow-left mr-2"></i> Kembali ke Home
                </a>
                <button id="openModalBtn" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-full font-semibold transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg flex items-center justify-center">
                    <i class="fas fa-plus-circle mr-2"></i> Tambah Pengguna Baru
                </button>
            </div>
        </div>


        <div class="bg-white/80 backdrop-blur-md rounded-3xl shadow-2xl p-6 md:p-10 lg:p-12">
            
            <div class="bg-gray-800 text-white p-4 md:p-6 rounded-t-2xl font-bold text-xl flex items-center gap-3">
                <i class="fas fa-list-alt"></i> Daftar Pengguna Sistem
            </div>

            <form action="{{ url_for('manage_users') }}" method="GET" class="mt-4 mb-4 flex justify-end">
                <div class="relative w-full max-w-sm">
                    <input type="text" id="searchInput" name="query" placeholder="Cari username..." value="{{ request.args.get('query', '') }}" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors">
                    <button type="submit" class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400 hover:text-indigo-500 transition-colors duration-200">
                        <i class="fas fa-search"></i>
                    </button>
                    {% if request.args.get('query') %}
                    <a href="{{ url_for('manage_users') }}" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-red-500 transition-colors duration-200" title="Hapus pencarian">
                        <i class="fas fa-times-circle"></i>
                    </a>
                    {% endif %}
                </div>
            </form>

            <div class="overflow-x-auto rounded-b-2xl">
                <table class="table-mobile-card min-w-full divide-y divide-gray-200 bg-white">
                    <thead class="bg-gray-50">

            <div class="overflow-x-auto rounded-b-2xl">
                <table class="table-mobile-card min-w-full divide-y divide-gray-200 bg-white">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bagian / Departemen</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama PIC</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                            <th scope="col" class="px-6 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for u in users %}
                        <tr class="hover:bg-gray-50 transition duration-150 ease-in-out">
                            <td class="px-6 py-4 font-semibold text-gray-900 md:font-normal md:text-gray-800" data-label="Username:">{{ u.username }}</td>
                            <td class="px-6 py-4" data-label="Departemen:">{{ u.department }}</td>
                            <td class="px-6 py-4" data-label="Nama PIC:">{{ u.pic_name }}</td>
                            <td class="px-6 py-4" data-label="Role:">{{ u.role }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-center actions-cell" data-label="Aksi:">
                                <div class="flex flex-col md:flex-row justify-center items-center gap-2">
                                    <button
                                        type="button"
                                        class="open-edit-modal-btn inline-flex items-center px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors duration-200 text-sm"
                                        data-user-id="{{ u.id }}"
                                        data-user-username="{{ u.username }}"
                                        data-user-department="{{ u.department }}"
                                        data-user-picname="{{ u.pic_name }}"
                                        data-user-role="{{ u.role }}"
                                    >
                                        <i class="fas fa-edit mr-2"></i> Edit
                                    </button>
                                    <button type="button" class="open-delete-modal-btn inline-flex items-center px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors duration-200 text-sm" data-user-id="{{ u.id }}" data-user-name="{{ u.username }}">
                                        <i class="fas fa-trash-alt mr-2"></i> Hapus
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center py-6 text-gray-500">
                                <i class="fas fa-inbox fa-3x mb-2"></i>
                                <p>
                                {% if request.args.get('query') %}
                                Tidak ada pengguna yang cocok dengan pencarian Anda.
                                {% else %}
                                Belum ada pengguna terdaftar.
                                {% endif %}
                                </p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

    <div class="flex justify-center mt-6">
        <nav class="inline-flex rounded-md shadow-sm" aria-label="Pagination">
            {% if pagination.has_prev %}
                <a href="{{ url_for('manage_users', page=pagination.prev_num, query=request.args.get('query', '')) }}" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-l-md">Previous</a>
            {% else %}
                <span class="px-4 py-2 text-sm font-medium text-gray-400 bg-gray-200 rounded-l-md cursor-not-allowed">Previous</span>
            {% endif %}

            {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                {% if p %}
                    {% if p == pagination.page %}
                    <a href="{{ url_for('manage_users', page=p, query=request.args.get('query', '')) }}" class="px-4 py-2 text-sm font-medium bg-indigo-500 text-white">{{ p }}</a>
                    {% else %}
                    <a href="{{ url_for('manage_users', page=p, query=request.args.get('query', '')) }}" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white hover:bg-gray-100">{{ p }}</a>
                    {% endif %}
                {% else %}
                    <span class="px-4 py-2 text-sm font-medium text-gray-500 bg-white cursor-default">...</span>
                {% endif %}
            {% endfor %}

            {% if pagination.has_next %}
                <a href="{{ url_for('manage_users', page=pagination.next_num, query=request.args.get('query', '')) }}" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-r-md">Next</a>
            {% else %}
                <span class="px-4 py-2 text-sm font-medium text-gray-400 bg-gray-200 rounded-r-md cursor-not-allowed">Next</span>
            {% endif %}
        </nav>
    </div>


            </div>
        </div>
    </div>
</div>

<div id="addModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 transition-all duration-300 hidden opacity-0 invisible" aria-hidden="true" aria-labelledby="addModalTitle" role="dialog" tabindex="-1">
    <div class="modal-content bg-white w-full max-w-lg mx-auto rounded-3xl shadow-2xl overflow-hidden transform transition-all duration-300 scale-95" role="document">
        <div class="bg-gray-800 text-white p-6 rounded-t-3xl font-bold text-xl flex items-center justify-between gap-3">
            <h3 id="addModalTitle" class="flex items-center">
                <i class="fas fa-user-plus mr-3"></i> Tambah Pengguna Baru
            </h3>
            <button id="closeAddModalBtn" type="button" class="text-gray-400 hover:text-white transition-colors duration-200" aria-label="Tutup modal">
                <i class="fas fa-times fa-lg"></i>
            </button>
        </div>
        <div class="p-6 md:p-8 max-h-[80vh] overflow-y-auto">
            <form id="addForm" method="POST" action="{{ url_for('add_user') }}" class="space-y-6" novalidate>
                <div>
                    <label for="username_add" class="block text-sm font-semibold text-gray-700 mb-2">Username</label>
                    <input type="text" class="form-input block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50" id="username_add" name="username" required placeholder="Masukkan username">
                    <div class="form-error text-red-500 text-sm mt-1 hidden">Username wajib diisi.</div>
                </div>

                <div>
                    <label for="password_add" class="block text-sm font-semibold text-gray-700 mb-2">Password *</label>
                    <div class="relative">
                        <input type="password" class="form-input pr-12 block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50" id="password_add" name="password" required placeholder="Masukkan password">
                        <span class="password-toggle absolute right-0 top-0 h-full flex items-center px-4 text-gray-500 cursor-pointer rounded-r-lg transition duration-200 hover:text-gray-700 hover:bg-gray-200" id="togglePassword_add">
                            <i class="fa fa-eye-slash" aria-hidden="true"></i>
                        </span>
                    </div>
                    <div class="form-error text-red-500 text-sm mt-1 hidden">Password wajib diisi untuk pengguna baru.</div>
                </div>

                <div>
                    <label for="department_add" class="block text-sm font-semibold text-gray-700 mb-2">Bagian / Departemen</label>
                    <div class="relative">
                        <select class="form-input form-select appearance-none block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50 custom-select-arrow pr-10" id="department_add" name="department" required>
                            <option value="" disabled selected>-- Pilih Bagian / Departemen --</option>
                            <option value="CLF">CLF</option>
                            <option value="CRA">CRA</option>
                            <option value="CRO">CRO</option>
                            <option value="CRR">CRR</option>
                            <option value="HC">HC</option>
                            <option value="IT">IT</option>
                            <option value="LEGAL">LEGAL</option>
                            <option value="LGAN">LGAN</option>
                            <option value="MICRO">MICRO</option>
                            <option value="MES 1">MES 1</option>
                            <option value="MES 2">MES 2</option>
                            <option value="SECURED">SECURED</option>
                            <option value="OSE">OSE</option>
                            <option value="RSF">RSF</option>
                            <option value="RFD">RFD</option>
                            <option value="RMC">RMC</option>
                            <option value="RTB">RTB</option>
                            <option value="RTD">RTD</option>
                            <option value="UNSECURED">UNSECURED</option>
                            <option value="SMALL">SMALL</option>
                            <option value="MEDIUM">MEDIUM</option>
                            <option value="COMMERCIAL">COMMERCIAL</option>
                        </select>
                        <div class="form-error text-red-500 text-sm mt-1 hidden">Bagian/Departemen wajib dipilih.</div>
                    </div>
                </div>

                <div>
                    <label for="picName_add" class="block text-sm font-semibold text-gray-700 mb-2">Nama PIC</label>
                    <input type="text" class="form-input block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50" id="picName_add" name="pic_name" required placeholder="Masukkan nama PIC (Person In Charge)">
                    <div class="form-error text-red-500 text-sm mt-1 hidden">Nama PIC wajib diisi dan hanya boleh mengandung huruf dan spasi.</div>
                </div>

                <div>
                    <label for="role_add" class="block text-sm font-semibold text-gray-700 mb-2">Role</label>
                    <div class="relative">
                        <select class="form-input form-select appearance-none block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50 custom-select-arrow pr-10" id="role_add" name="role">
                            <option value="admin">Admin</option>
                            <option value="user" selected>Requester</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-full font-semibold transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg flex items-center">
                        <i class="fas fa-plus-circle mr-2"></i> Tambah
                    </button>
                    <button type="button" id="cancelAddModalBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-full font-semibold transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg flex items-center">
                        <i class="fas fa-times-circle mr-2"></i> Batal
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="editModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 transition-all duration-300 hidden opacity-0 invisible" aria-hidden="true" aria-labelledby="editModalTitle" role="dialog" tabindex="-1">
    <div class="modal-content bg-white w-full max-w-lg mx-auto rounded-3xl shadow-2xl overflow-hidden transform transition-all duration-300 scale-95" role="document">
        <div class="bg-gray-800 text-white p-6 rounded-t-3xl font-bold text-xl flex items-center justify-between gap-3">
            <h3 id="editModalTitle" class="flex items-center">
                <i class="fas fa-user-edit mr-3"></i> Edit Pengguna
            </h3>
            <button id="closeEditModalBtn" type="button" class="text-gray-400 hover:text-white transition-colors duration-200" aria-label="Tutup modal">
                <i class="fas fa-times fa-lg"></i>
            </button>
        </div>
        <div class="p-6 md:p-8 max-h-[80vh] overflow-y-auto">
            <form id="editForm" method="POST" action="" class="space-y-6" novalidate>
                <input type="hidden" name="id" id="userId_edit">
                <input type="hidden" name="username" id="usernameHidden_edit">

                <div>
                    <label for="username_edit_display" class="block text-sm font-semibold text-gray-700 mb-2">Username</label>
                    <input type="text" class="form-input block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50" id="username_edit_display" readonly>
                    <p class="text-xs text-gray-500 mt-1">Username tidak dapat diubah setelah dibuat.</p>
                </div>

                <div>
                    <label for="password_edit" class="block text-sm font-semibold text-gray-700 mb-2">Password (kosongkan jika tidak ingin mengubah)</label>
                    <div class="relative">
                        <input type="password" class="form-input pr-12 block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50" id="password_edit" name="password" placeholder="Biarkan kosong untuk tidak mengubah password">
                        <span class="password-toggle absolute right-0 top-0 h-full flex items-center px-4 text-gray-500 cursor-pointer rounded-r-lg transition duration-200 hover:text-gray-700 hover:bg-gray-200" id="togglePassword_edit">
                            <i class="fa fa-eye-slash" aria-hidden="true"></i>
                        </span>
                    </div>
                    <div class="form-error text-red-500 text-sm mt-1 hidden"></div>
                </div>

                <div>
                    <label for="department_edit" class="block text-sm font-semibold text-gray-700 mb-2">Bagian / Departemen</label>
                    <div class="relative">
                        <select class="form-input form-select appearance-none block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50 custom-select-arrow pr-10" id="department_edit" name="department" required>
                            <option value="" disabled>-- Pilih Bagian / Departemen --</option>
                            <option value="CLF">CLF</option>
                            <option value="CRA">CRA</option>
                            <option value="CRO">CRO</option>
                            <option value="CRR">CRR</option>
                            <option value="HC">HC</option>
                            <option value="IT">IT</option>
                            <option value="LEGAL">LEGAL</option>
                            <option value="LGAN">LGAN</option>
                            <option value="MICRO">MICRO</option>
                            <option value="MES 1">MES 1</option>
                            <option value="MES 2">MES 2</option>
                            <option value="SECURED">SECURED</option>
                            <option value="OSE">OSE</option>
                            <option value="RSF">RSF</option>
                            <option value="RFD">RFD</option>
                            <option value="RMC">RMC</option>
                            <option value="RTB">RTB</option>
                            <option value="RTD">RTD</option>
                            <option value="UNSECURED">UNSECURED</option>
                            <option value="SMALL">SMALL</option>
                            <option value="MEDIUM">MEDIUM</option>
                            <option value="COMMERCIAL">COMMERCIAL</option>
                        </select>
                        <div class="form-error text-red-500 text-sm mt-1 hidden">Bagian/Departemen wajib dipilih.</div>
                    </div>
                </div>

                <div>
                    <label for="picName_edit" class="block text-sm font-semibold text-gray-700 mb-2">Nama PIC</label>
                    <input type="text" class="form-input block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50" id="picName_edit" name="pic_name" required placeholder="Masukkan nama PIC (Person In Charge)">
                    <div class="form-error text-red-500 text-sm mt-1 hidden">Nama PIC wajib diisi dan hanya boleh mengandung huruf dan spasi.</div>
                </div>

                <div>
                    <label for="role_edit" class="block text-sm font-semibold text-gray-700 mb-2">Role</label>
                    <div class="relative">
                        <select class="form-input form-select appearance-none block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50 custom-select-arrow pr-10" id="role_edit" name="role">
                            <option value="admin">Admin</option>
                            <option value="user">Requester</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-full font-semibold transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg flex items-center">
                        <i class="fas fa-save mr-2"></i> Update
                    </button>
                    <button type="button" id="cancelEditModalBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-full font-semibold transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg flex items-center">
                        <i class="fas fa-times-circle mr-2"></i> Kembali
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="deleteModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 transition-all duration-300 hidden opacity-0 invisible" aria-hidden="true" aria-labelledby="deleteModalTitle" role="dialog" tabindex="-1">
    <div class="modal-content bg-white w-full max-w-sm mx-auto rounded-3xl shadow-2xl overflow-hidden transform transition-all duration-300 scale-95" role="document">
        <div class="p-6 md:p-8 text-center">
            <i class="fas fa-exclamation-triangle text-red-500 text-6xl mb-4 animate-pulse"></i>
            <h3 id="deleteModalTitle" class="text-2xl font-bold text-gray-800 mb-2">Hapus Pengguna?</h3>
            <p id="deleteMessage" class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus pengguna <span class="font-semibold text-gray-900" id="userNameToDelete"></span>? Tindakan ini tidak dapat diurungkan.</p>
            <div class="flex justify-center gap-3">
                <a href="#" id="confirmDeleteBtn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-full font-semibold transition duration-300 ease-in-out flex items-center">
                    <i class="fas fa-trash-alt mr-2"></i> Ya, Hapus
                </a>
                <button type="button" id="cancelDeleteBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 rounded-full font-semibold transition duration-300 ease-in-out flex items-center">
                    <i class="fas fa-times-circle mr-2"></i> Batal
                </button>
            </div>
        </div>
    </div>
</div>

<script>

    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        let timeout = null;

        // Mendengarkan setiap input pada kotak pencarian
        searchInput.addEventListener('input', function() {
            // Hapus timeout sebelumnya
            clearTimeout(timeout);

            // Set timeout baru
            timeout = setTimeout(function() {
                // Ambil nilai input
                const query = searchInput.value;
                const currentUrl = new URL(window.location.href);
                
                // Tambahkan atau perbarui parameter 'query' di URL
                if (query) {
                    currentUrl.searchParams.set('query', query);
                } else {
                    currentUrl.searchParams.delete('query');
                }


                window.location.href = currentUrl.toString();
            }, 1000); // Waktu tunda 500ms (setengah detik)
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        // --- Logika Toggle Password ---
        const togglePassword_add = document.querySelector('#togglePassword_add');
        const passwordInput_add = document.querySelector('#password_add');
        const togglePassword_edit = document.querySelector('#togglePassword_edit');
        const passwordInput_edit = document.querySelector('#password_edit');

        if (togglePassword_add && passwordInput_add) {
            togglePassword_add.addEventListener('click', function () {
                const type = passwordInput_add.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput_add.setAttribute('type', type);
                this.querySelector('i').classList.toggle('fa-eye');
                this.querySelector('i').classList.toggle('fa-eye-slash');
            });
        }

        if (togglePassword_edit && passwordInput_edit) {
            togglePassword_edit.addEventListener('click', function () {
                const type = passwordInput_edit.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput_edit.setAttribute('type', type);
                this.querySelector('i').classList.toggle('fa-eye');
                this.querySelector('i').classList.toggle('fa-eye-slash');
            });
        }

        // --- Logika Modal Tambah Pengguna ---
        const addModal = document.getElementById('addModal');
        const openModalBtn = document.getElementById('openModalBtn');
        const closeAddModalBtn = document.getElementById('closeAddModalBtn');
        const cancelAddModalBtn = document.getElementById('cancelAddModalBtn');
        const addForm = document.getElementById('addForm');

        function openAddModal() {
            addModal.classList.remove('hidden', 'opacity-0', 'invisible');
            addModal.classList.add('flex', 'opacity-100', 'visible');
            document.body.classList.add('overflow-hidden');
            addForm.reset();
            addForm.querySelectorAll('.form-input').forEach(input => {
                input.classList.remove('is-invalid');
            });
            addForm.querySelectorAll('.form-error').forEach(error => {
                error.classList.add('hidden');
            });
        }

        function closeAddModal() {
            addModal.classList.remove('flex', 'opacity-100', 'visible');
            addModal.classList.add('hidden', 'opacity-0', 'invisible');
            document.body.classList.remove('overflow-hidden');
        }

        if (openModalBtn) { openModalBtn.addEventListener('click', openAddModal); }
        if (closeAddModalBtn) { closeAddModalBtn.addEventListener('click', closeAddModal); }
        if (cancelAddModalBtn) { cancelAddModalBtn.addEventListener('click', closeAddModal); }

        addModal.addEventListener('click', function(e) {
            if (e.target === addModal) { closeAddModal(); }
        });

        addForm.addEventListener('submit', function(e) {
            let isValid = true;
            const requiredInputs = addForm.querySelectorAll('[required]');

            requiredInputs.forEach(input => {
                const errorDiv = input.closest('div').querySelector('.form-error');
                if (!input.value.trim()) {
                    input.classList.add('is-invalid');
                    if (errorDiv) {
                        errorDiv.classList.remove('hidden');
                        if (input.tagName === 'SELECT') {
                            errorDiv.textContent = 'Bagian/Departemen wajib dipilih.';
                        } else {
                            errorDiv.textContent = `${input.previousElementSibling.textContent} wajib diisi.`;
                        }
                    }
                    isValid = false;
                } else {
                    input.classList.remove('is-invalid');
                    if (errorDiv) {
                        errorDiv.classList.add('hidden');
                    }
                }
            });

            const picNameInput = document.getElementById('picName_add');
            const picNameError = picNameInput.closest('div').querySelector('.form-error');
            const picNameRegex = /^[A-Za-z\s]+$/;
            if (picNameInput.value.trim() && !picNameRegex.test(picNameInput.value.trim())) {
                picNameInput.classList.add('is-invalid');
                if (picNameError) {
                    picNameError.classList.remove('hidden');
                    picNameError.textContent = 'Nama PIC hanya boleh mengandung huruf dan spasi.';
                }
                isValid = false;
            } else if (picNameInput.value.trim()) {
                picNameInput.classList.remove('is-invalid');
                if (picNameError) {
                    picNameError.classList.add('hidden');
                }
            }


            if (!isValid) {
                e.preventDefault();
            }
        });


        // --- Logika Modal Hapus Pengguna Kustom ---
        const deleteModal = document.getElementById('deleteModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const userNameToDeleteSpan = document.getElementById('userNameToDelete');

        document.querySelectorAll('.open-delete-modal-btn').forEach(button => {
            button.addEventListener('click', function() {
                const userId = this.dataset.userId;
                const userName = this.dataset.userName;

                confirmDeleteBtn.href = `{{ url_for('delete_user', user_id=0) }}`.replace('0', userId);
                userNameToDeleteSpan.textContent = userName;

                deleteModal.classList.remove('hidden', 'opacity-0', 'invisible');
                deleteModal.classList.add('flex', 'opacity-100', 'visible');
                document.body.classList.add('overflow-hidden');
            });
        });

        if (cancelDeleteBtn) {
            cancelDeleteBtn.addEventListener('click', function() {
                deleteModal.classList.remove('flex', 'opacity-100', 'visible');
                deleteModal.classList.add('hidden', 'opacity-0', 'invisible');
                document.body.classList.remove('overflow-hidden');
            });
        }

        deleteModal.addEventListener('click', function(e) {
            if (e.target === deleteModal) {
                deleteModal.classList.remove('flex', 'opacity-100', 'visible');
                deleteModal.classList.add('hidden', 'opacity-0', 'invisible');
                document.body.classList.remove('overflow-hidden');
            }
        });

        // --- Logika Modal Edit Pengguna ---
        const editModal = document.getElementById('editModal');
        const closeEditModalBtn = document.getElementById('closeEditModalBtn');
        const cancelEditModalBtn = document.getElementById('cancelEditModalBtn');
        const editForm = document.getElementById('editForm');

        document.querySelectorAll('.open-edit-modal-btn').forEach(button => {
            button.addEventListener('click', function() {
                const userId = this.dataset.userId;
                const username = this.dataset.userUsername;
                const department = this.dataset.userDepartment;
                const picName = this.dataset.userPicname;
                const role = this.dataset.userRole;

                document.getElementById('userId_edit').value = userId;
                document.getElementById('username_edit_display').value = username;
                document.getElementById('usernameHidden_edit').value = username;
                document.getElementById('department_edit').value = department;
                document.getElementById('picName_edit').value = picName;
                document.getElementById('role_edit').value = role;

                editForm.action = `{{ url_for('edit_user', user_id=0) }}`.replace('0', userId);

                editModal.classList.remove('hidden', 'opacity-0', 'invisible');
                editModal.classList.add('flex', 'opacity-100', 'visible');
                document.body.classList.add('overflow-hidden');

                editForm.querySelectorAll('.form-input').forEach(input => {
                    input.classList.remove('is-invalid');
                });
                editForm.querySelectorAll('.form-error').forEach(error => {
                    error.classList.add('hidden');
                });
            });
        });

        function closeEditModal() {
            editModal.classList.remove('flex', 'opacity-100', 'visible');
            editModal.classList.add('hidden', 'opacity-0', 'invisible');
            document.body.classList.remove('overflow-hidden');
        }

        if (closeEditModalBtn) { closeEditModalBtn.addEventListener('click', closeEditModal); }
        if (cancelEditModalBtn) { cancelEditModalBtn.addEventListener('click', closeEditModal); }

        editModal.addEventListener('click', function(e) {
            if (e.target === editModal) { closeEditModal(); }
        });
        
        editForm.addEventListener('submit', function(e) {
            let isValid = true;
            
            const departmentInput = document.getElementById('department_edit');
            const picNameInput = document.getElementById('picName_edit');

            if (!departmentInput.value.trim()) {
                departmentInput.classList.add('is-invalid');
                const errorDiv = departmentInput.closest('div').querySelector('.form-error');
                if (errorDiv) {
                    errorDiv.textContent = 'Bagian/Departemen wajib dipilih.';
                    errorDiv.classList.remove('hidden');
                }
                isValid = false;
            } else {
                departmentInput.classList.remove('is-invalid');
                const errorDiv = departmentInput.closest('div').querySelector('.form-error');
                if (errorDiv) { errorDiv.classList.add('hidden'); }
            }

            const picNameRegex = /^[A-Za-z\s]+$/;
            if (!picNameInput.value.trim()) {
                picNameInput.classList.add('is-invalid');
                const errorDiv = picNameInput.closest('div').querySelector('.form-error');
                if (errorDiv) {
                    errorDiv.textContent = 'Nama PIC wajib diisi.';
                    errorDiv.classList.remove('hidden');
                }
                isValid = false;
            } else if (!picNameRegex.test(picNameInput.value.trim())) {
                picNameInput.classList.add('is-invalid');
                const errorDiv = picNameInput.closest('div').querySelector('.form-error');
                if (errorDiv) {
                    errorDiv.textContent = 'Nama PIC hanya boleh mengandung huruf dan spasi.';
                    errorDiv.classList.remove('hidden');
                }
                isValid = false;
            } else {
                picNameInput.classList.remove('is-invalid');
                const errorDiv = picNameInput.closest('div').querySelector('.form-error');
                if (errorDiv) { errorDiv.classList.add('hidden'); }
            }

            if (!isValid) {
                e.preventDefault();
            }
        });
    });
</script>
</body>
</html>