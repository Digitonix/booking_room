<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Management Users
    </title>

    <!-- Memuat Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Memuat Font Awesome untuk ikon -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <!-- Memuat font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Gaya khusus untuk panah dropdown select */
        .custom-select-arrow {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'%3e%3c/path%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }

        /* Gaya untuk input yang tidak valid */
        .form-input.is-invalid {
            border-color: #ef4444 !important; /* red-500 */
        }

        /* Transisi untuk modal */
        .modal {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }

        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<!-- Kontainer utama aplikasi -->
<div class="container mx-auto px-4 py-8 md:py-12 max-w-6xl">
    <div class="bg-white/80 backdrop-blur-md rounded-3xl shadow-2xl p-6 md:p-10 lg:p-12 mb-8">
        <div class="flex items-center mb-6">
            <h2 class="text-indigo-600 font-bold text-3xl md:text-4xl">
                <i class="fas fa-users-cog mr-3"></i>Management Users
            </h2>
        </div>

        <!-- Tombol untuk membuka modal 'Tambah Pengguna Baru' -->
        <div class="flex justify-between items-center mb-6">
            <a href="{{ url_for('home') }}" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-full font-semibold transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> Kembali ke Home
            </a>

            <button id="openModalBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-full font-semibold transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg flex items-center">
                <i class="fas fa-plus-circle mr-2"></i> Tambah Pengguna Baru
            </button>
        </div>

        <!-- Tampilan tabel daftar pengguna -->
        <div class="bg-white/80 backdrop-blur-md rounded-3xl shadow-2xl p-6 md:p-10 lg:p-12">
            <div class="bg-gray-800 text-white p-6 rounded-t-2xl font-bold text-xl flex items-center gap-3">
                <i class="fas fa-list-alt"></i> Daftar Pengguna Sistem
            </div>
            <div class="overflow-x-auto rounded-b-2xl">
                <table class="min-w-full divide-y divide-gray-200 bg-white">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bagian / Departemen</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama PIC</th>
                            <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                            <th scope="col" class="px-6 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        <!-- Perbaikan: Menambahkan <td> untuk Role dan memindahkan tombol aksi ke <td> terpisah -->
                        {% for u in users %}
                        <tr class="hover:bg-gray-50 transition duration-150 ease-in-out">
                            <td class="px-6 py-4">{{ u.username }}</td>
                            <td class="px-6 py-4">{{ u.department }}</td>
                            <td class="px-6 py-4">{{ u.pic_name }}</td>
                            <td class="px-6 py-4">{{ u.role }}</td> <!-- Kolom Role yang diperbaiki -->
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <div class="flex flex-col md:flex-row justify-center items-center gap-2">
                                    <button
                                        type="button"
                                        class="open-edit-modal-btn inline-flex items-center px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors duration-200 text-sm"
                                        data-user-id="{{ u.id }}"
                                        data-user-username="{{ u.username }}"
                                        data-user-department="{{ u.department }}"
                                        data-user-picname="{{ u.pic_name }}"
                                        data-user-role="{{ u.role }}"
                                    >
                                        <i class="fas fa-edit mr-2"></i> Edit
                                    </button>
                                    <button type="button" class="open-delete-modal-btn inline-flex items-center px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors duration-200 text-sm" data-user-id="{{ u.id }}" data-user-name="{{ u.username }}">
                                        <i class="fas fa-trash-alt mr-2"></i> Hapus
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center py-6 text-gray-500">
                                <i class="fas fa-inbox fa-3x mb-2"></i>
                                <p>Belum ada pengguna terdaftar.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

    <!-- Pagination -->
    <div class="flex justify-center mt-6">
        <nav class="inline-flex rounded-md shadow-sm" aria-label="Pagination">
            {% if page > 1 %}
                <a href="{{ url_for('manage_users', page=page-1) }}" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-l-md">Previous</a>
            {% else %}
                <span class="px-4 py-2 text-sm font-medium text-gray-400 bg-gray-200 rounded-l-md cursor-not-allowed">Previous</span>
            {% endif %}

            {% for p in range(1, total_pages + 1) %}
                <a href="{{ url_for('manage_users', page=p) }}" class="px-4 py-2 text-sm font-medium {% if p == page %}bg-indigo-500 text-white{% else %}text-gray-700 bg-white hover:bg-gray-100{% endif %}">
                    {{ p }}
                </a>
            {% endfor %}

            {% if page < total_pages %}
                <a href="{{ url_for('manage_users', page=page+1) }}" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 rounded-r-md">Next</a>
            {% else %}
                <span class="px-4 py-2 text-sm font-medium text-gray-400 bg-gray-200 rounded-r-md cursor-not-allowed">Next</span>
            {% endif %}
        </nav>
    </div>


            </div>
        </div>
    </div>
</div>

<!-- Modal 'Tambah Pengguna Baru' -->
<div id="addModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 transition-all duration-300 hidden opacity-0 invisible" aria-hidden="true" aria-labelledby="addModalTitle" role="dialog" tabindex="-1">
    <div class="modal-content bg-white w-full max-w-lg mx-auto rounded-3xl shadow-2xl overflow-hidden transform transition-all duration-300 scale-95" role="document">
        <div class="bg-gray-800 text-white p-6 rounded-t-3xl font-bold text-xl flex items-center justify-between gap-3">
            <h3 id="addModalTitle" class="flex items-center">
                <i class="fas fa-user-plus mr-3"></i> Tambah Pengguna Baru
            </h3>
            <button id="closeAddModalBtn" type="button" class="text-gray-400 hover:text-white transition-colors duration-200" aria-label="Tutup modal">
                <i class="fas fa-times fa-lg"></i>
            </button>
        </div>
        <div class="p-6 md:p-8 max-h-[80vh] overflow-y-auto">
            <!-- Formulir 'Tambah Pengguna Baru' -->
            <form id="addForm" method="POST" action="{{ url_for('add_user') }}" class="space-y-6" novalidate>
                <div>
                    <label for="username_add" class="block text-sm font-semibold text-gray-700 mb-2">Username</label>
                    <input type="text" class="form-input block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50" id="username_add" name="username" required placeholder="Masukkan username">
                    <div class="form-error text-red-500 text-sm mt-1 hidden">Username wajib diisi.</div>
                </div>

                <div>
                    <label for="password_add" class="block text-sm font-semibold text-gray-700 mb-2">Password *</label>
                    <div class="relative">
                        <input type="password" class="form-input pr-12 block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50" id="password_add" name="password" required placeholder="Masukkan password">
                        <span class="password-toggle absolute right-0 top-0 h-full flex items-center px-4 text-gray-500 cursor-pointer rounded-r-lg transition duration-200 hover:text-gray-700 hover:bg-gray-200" id="togglePassword_add">
                            <i class="fa fa-eye-slash" aria-hidden="true"></i>
                        </span>
                    </div>
                    <div class="form-error text-red-500 text-sm mt-1 hidden">Password wajib diisi untuk pengguna baru.</div>
                </div>

                <div>
                    <label for="department_add" class="block text-sm font-semibold text-gray-700 mb-2">Bagian / Departemen</label>
                    <div class="relative">
                        <select class="form-input form-select appearance-none block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50 custom-select-arrow pr-10" id="department_add" name="department" required>
                            <option value="" disabled selected>-- Pilih Bagian / Departemen --</option>
                            <option value="CLF">CLF</option>
                            <option value="CRA">CRA</option>
                            <option value="CRO">CRO</option>
                            <option value="CRR">CRR</option>
                            <option value="HC">HC</option>
                            <option value="IT">IT</option>
                            <option value="LEGAL">LEGAL</option>
                            <option value="LGAN">LGAN</option>
                            <option value="MICRO">MICRO</option>
                            <option value="MES 1">MES 1</option>
                            <option value="MES 2">MES 2</option>
                            <option value="SECURED">SECURED</option>
                            <option value="OSE">OSE</option>
                            <option value="RSF">RSF</option>
                            <option value="RFD">RFD</option>
                            <option value="RMC">RMC</option>
                            <option value="RTB">RTB</option>
                            <option value="RTD">RTD</option>
                            <option value="UNSECURED">UNSECURED</option>
                            <option value="SMALL">SMALL</option>
                            <option value="MEDIUM">MEDIUM</option>
                            <option value="COMMERCIAL">COMMERCIAL</option>
                        </select>
                        <div class="form-error text-red-500 text-sm mt-1 hidden">Bagian/Departemen wajib dipilih.</div>
                    </div>
                </div>

                <div>
                    <label for="picName_add" class="block text-sm font-semibold text-gray-700 mb-2">Nama PIC</label>
                    <input type="text" class="form-input block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50" id="picName_add" name="pic_name" required placeholder="Masukkan nama PIC (Person In Charge)">
                    <div class="form-error text-red-500 text-sm mt-1 hidden">Nama PIC wajib diisi dan hanya boleh mengandung huruf dan spasi.</div>
                </div>

                <div>
                    <label for="role_add" class="block text-sm font-semibold text-gray-700 mb-2">Role</label>
                    <div class="relative">
                        <select class="form-input form-select appearance-none block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50 custom-select-arrow pr-10" id="role_add" name="role">
                            <option value="admin">Admin</option>
                            <option value="user" selected>Requester</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-full font-semibold transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg flex items-center">
                        <i class="fas fa-plus-circle mr-2"></i> Tambah
                    </button>
                    <button type="button" id="cancelAddModalBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-full font-semibold transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg flex items-center">
                        <i class="fas fa-times-circle mr-2"></i> Batal
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal 'Edit Pengguna' BARU -->
<div id="editModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 transition-all duration-300 hidden opacity-0 invisible" aria-hidden="true" aria-labelledby="editModalTitle" role="dialog" tabindex="-1">
    <div class="modal-content bg-white w-full max-w-lg mx-auto rounded-3xl shadow-2xl overflow-hidden transform transition-all duration-300 scale-95" role="document">
        <div class="bg-gray-800 text-white p-6 rounded-t-3xl font-bold text-xl flex items-center justify-between gap-3">
            <h3 id="editModalTitle" class="flex items-center">
                <i class="fas fa-user-edit mr-3"></i> Edit Pengguna
            </h3>
            <button id="closeEditModalBtn" type="button" class="text-gray-400 hover:text-white transition-colors duration-200" aria-label="Tutup modal">
                <i class="fas fa-times fa-lg"></i>
            </button>
        </div>
        <div class="p-6 md:p-8 max-h-[80vh] overflow-y-auto">
            <!-- Formulir Edit Pengguna (dipindahkan ke sini) -->
            <form id="editForm" method="POST" action="" class="space-y-6" novalidate>
                <input type="hidden" name="id" id="userId_edit">

                <div>
                    <label for="username_edit" class="block text-sm font-semibold text-gray-700 mb-2">Username</label>
                    <input type="text" class="form-input block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50" id="username_edit" readonly>
                    <input type="hidden" name="username" id="usernameHidden_edit">
                    <p class="text-xs text-gray-500 mt-1">Username tidak dapat diubah setelah dibuat.</p>
                </div>

                <div>
                    <label for="password_edit" class="block text-sm font-semibold text-gray-700 mb-2">Password (kosongkan jika tidak ingin mengubah)</label>
                    <div class="relative">
                        <input type="password" class="form-input pr-12 block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50" id="password_edit" name="password" placeholder="Biarkan kosong untuk tidak mengubah password">
                        <span class="password-toggle absolute right-0 top-0 h-full flex items-center px-4 text-gray-500 cursor-pointer rounded-r-lg transition duration-200 hover:text-gray-700 hover:bg-gray-200" id="togglePassword_edit">
                            <i class="fa fa-eye-slash" aria-hidden="true"></i>
                        </span>
                    </div>
                    <div class="form-error text-red-500 text-sm mt-1 hidden"></div>
                </div>

                <div>
                    <label for="department_edit" class="block text-sm font-semibold text-gray-700 mb-2">Bagian / Departemen</label>
                    <div class="relative">
                        <select class="form-input form-select appearance-none block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50 custom-select-arrow pr-10" id="department_edit" name="department" required>
                            <option value="" disabled>-- Pilih Bagian / Departemen --</option>
                            <option value="CLF">CLF</option>
                            <option value="CRA">CRA</option>
                            <option value="CRO">CRO</option>
                            <option value="CRR">CRR</option>
                            <option value="HC">HC</option>
                            <option value="IT">IT</option>
                            <option value="LEGAL">LEGAL</option>
                            <option value="LGAN">LGAN</option>
                            <option value="MICRO">MICRO</option>
                            <option value="MES 1">MES 1</option>
                            <option value="MES 2">MES 2</option>
                            <option value="SECURED">SECURED</option>
                            <option value="OSE">OSE</option>
                            <option value="RSF">RSF</option>
                            <option value="RFD">RFD</option>
                            <option value="RMC">RMC</option>
                            <option value="RTB">RTB</option>
                            <option value="RTD">RTD</option>
                            <option value="UNSECURED">UNSECURED</option>
                            <option value="SMALL">SMALL</option>
                            <option value="MEDIUM">MEDIUM</option>
                            <option value="COMMERCIAL">COMMERCIAL</option>
                        </select>
                        <div class="form-error text-red-500 text-sm mt-1 hidden">Bagian/Departemen wajib dipilih.</div>
                    </div>
                </div>

                <div>
                    <label for="picName_edit" class="block text-sm font-semibold text-gray-700 mb-2">Nama PIC</label>
                    <input type="text" class="form-input block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50" id="picName_edit" name="pic_name" required placeholder="Masukkan nama PIC (Person In Charge)">
                    <div class="form-error text-red-500 text-sm mt-1 hidden">Nama PIC wajib diisi dan hanya boleh mengandung huruf dan spasi.</div>
                </div>

                <div>
                    <label for="role_edit" class="block text-sm font-semibold text-gray-700 mb-2">Role</label>
                    <div class="relative">
                        <select class="form-input form-select appearance-none block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50 custom-select-arrow pr-10" id="role_edit" name="role">
                            <option value="admin">Admin</option>
                            <option value="user">Requester</option>
                        </select>
                    </div>
                </div>

                <div class="flex justify-end gap-3 pt-4">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-full font-semibold transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg flex items-center">
                        <i class="fas fa-save mr-2"></i> Update
                    </button>
                    <!-- TOMBOL KEMBALI BARU: Menambahkan tombol yang menutup modal -->
                    <button type="button" id="cancelEditModalBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-full font-semibold transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg flex items-center">
                        <i class="fas fa-times-circle mr-2"></i> Kembali
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Konfirmasi Hapus Kustom -->
<div id="deleteModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 transition-all duration-300 hidden opacity-0 invisible" aria-hidden="true" aria-labelledby="deleteModalTitle" role="dialog" tabindex="-1">
    <div class="modal-content bg-white w-full max-w-sm mx-auto rounded-3xl shadow-2xl overflow-hidden transform transition-all duration-300 scale-95" role="document">
        <div class="p-6 md:p-8 text-center">
            <i class="fas fa-exclamation-triangle text-red-500 text-6xl mb-4 animate-pulse"></i>
            <h3 id="deleteModalTitle" class="text-2xl font-bold text-gray-800 mb-2">Hapus Pengguna?</h3>
            <p id="deleteMessage" class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus pengguna <span class="font-semibold text-gray-900" id="userNameToDelete"></span>? Tindakan ini tidak dapat diurungkan.</p>
            <div class="flex justify-center gap-3">
                <a href="#" id="confirmDeleteBtn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-full font-semibold transition duration-300 ease-in-out flex items-center">
                    <i class="fas fa-trash-alt mr-2"></i> Ya, Hapus
                </a>
                <button type="button" id="cancelDeleteBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 rounded-full font-semibold transition duration-300 ease-in-out flex items-center">
                    <i class="fas fa-times-circle mr-2"></i> Batal
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Logika Toggle Password ---
        const togglePassword_add = document.querySelector('#togglePassword_add');
        const passwordInput_add = document.querySelector('#password_add');
        const togglePassword_edit = document.querySelector('#togglePassword_edit');
        const passwordInput_edit = document.querySelector('#password_edit');

        // Logika untuk toggle password pada formulir tambah
        if (togglePassword_add && passwordInput_add) {
            togglePassword_add.addEventListener('click', function () {
                const type = passwordInput_add.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput_add.setAttribute('type', type);
                this.querySelector('i').classList.toggle('fa-eye');
                this.querySelector('i').classList.toggle('fa-eye-slash');
            });
        }

        // Logika untuk toggle password pada formulir edit
        if (togglePassword_edit && passwordInput_edit) {
            togglePassword_edit.addEventListener('click', function () {
                const type = passwordInput_edit.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput_edit.setAttribute('type', type);
                this.querySelector('i').classList.toggle('fa-eye');
                this.querySelector('i').classList.toggle('fa-eye-slash');
            });
        }

        // --- Logika Modal Tambah Pengguna ---
        const addModal = document.getElementById('addModal');
        const openModalBtn = document.getElementById('openModalBtn');
        const closeAddModalBtn = document.getElementById('closeAddModalBtn');
        const cancelAddModalBtn = document.getElementById('cancelAddModalBtn');

        function openAddModal() {
            addModal.classList.remove('hidden', 'opacity-0', 'invisible');
            addModal.classList.add('flex', 'opacity-100', 'visible');
            document.body.classList.add('overflow-hidden');
        }

        function closeAddModal() {
            addModal.classList.remove('flex', 'opacity-100', 'visible');
            addModal.classList.add('hidden', 'opacity-0', 'invisible');
            document.body.classList.remove('overflow-hidden');
        }

        if (openModalBtn) { openModalBtn.addEventListener('click', openAddModal); }
        if (closeAddModalBtn) { closeAddModalBtn.addEventListener('click', closeAddModal); }
        if (cancelAddModalBtn) { cancelAddModalBtn.addEventListener('click', closeAddModal); }

        addModal.addEventListener('click', function(e) {
            if (e.target === addModal) { closeAddModal(); }
        });

        // --- Logika Modal Hapus Pengguna Kustom ---
        const deleteModal = document.getElementById('deleteModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const userNameToDeleteSpan = document.getElementById('userNameToDelete');

        document.querySelectorAll('.open-delete-modal-btn').forEach(button => {
            button.addEventListener('click', function() {
                const userId = this.dataset.userId;
                const userName = this.dataset.userName;

                // Mengatur tautan tombol konfirmasi ke URL delete yang benar
                // PENTING: Anda perlu mengganti 'delete_user' dengan nama endpoint Anda di backend.
                confirmDeleteBtn.href = `{{ url_for('delete_user', user_id=0) }}`.replace('0', userId);
                userNameToDeleteSpan.textContent = userName;

                deleteModal.classList.remove('hidden', 'opacity-0', 'invisible');
                deleteModal.classList.add('flex', 'opacity-100', 'visible');
                document.body.classList.add('overflow-hidden');
            });
        });

        if (cancelDeleteBtn) {
            cancelDeleteBtn.addEventListener('click', function() {
                deleteModal.classList.remove('flex', 'opacity-100', 'visible');
                deleteModal.classList.add('hidden', 'opacity-0', 'invisible');
                document.body.classList.remove('overflow-hidden');
            });
        }

        deleteModal.addEventListener('click', function(e) {
            if (e.target === deleteModal) {
                deleteModal.classList.remove('flex', 'opacity-100', 'visible');
                deleteModal.classList.add('hidden', 'opacity-0', 'invisible');
                document.body.classList.remove('overflow-hidden');
            }
        });

        // --- Logika Modal Edit Pengguna BARU ---
        const editModal = document.getElementById('editModal');
        const closeEditModalBtn = document.getElementById('closeEditModalBtn');
        const cancelEditModalBtn = document.getElementById('cancelEditModalBtn');

        document.querySelectorAll('.open-edit-modal-btn').forEach(button => {
            button.addEventListener('click', function() {
                const userId = this.dataset.userId;
                const username = this.dataset.userUsername;
                const department = this.dataset.userDepartment;
                const picName = this.dataset.userPicname;
                const role = this.dataset.userRole;

                document.getElementById('userId_edit').value = userId;
                document.getElementById('username_edit').value = username;
                document.getElementById('usernameHidden_edit').value = username;
                document.getElementById('department_edit').value = department;
                document.getElementById('picName_edit').value = picName;
                document.getElementById('role_edit').value = role;

                const editForm = document.getElementById('editForm');
                editForm.action = `{{ url_for('add_user') }}`; // FIXED: Gunakan endpoint add_user

                editModal.classList.remove('hidden', 'opacity-0', 'invisible');
                editModal.classList.add('flex', 'opacity-100', 'visible');
                document.body.classList.add('overflow-hidden');
            });
        });

        // Event listener untuk menutup modal edit
        function closeEditModal() {
            editModal.classList.remove('flex', 'opacity-100', 'visible');
            editModal.classList.add('hidden', 'opacity-0', 'invisible');
            document.body.classList.remove('overflow-hidden');
        }

        if (closeEditModalBtn) { closeEditModalBtn.addEventListener('click', closeEditModal); }
        if (cancelEditModalBtn) { cancelEditModalBtn.addEventListener('click', closeEditModal); }

        editModal.addEventListener('click', function(e) {
            if (e.target === editModal) { closeEditModal(); }
        });

        // --- Logika Validasi Formulir ---
        const addForm = document.querySelector('#addForm');
        const editForm = document.querySelector('#editForm');

        /**
         * Fungsi untuk menampilkan atau menyembunyikan pesan kesalahan.
         * @param {HTMLElement} inputElemen - Elemen input yang divalidasi.
         * @param {string} message - Pesan kesalahan yang akan ditampilkan.
         */
        function showValidationError(inputElement, message) {
            inputElement.classList.add('is-invalid');
            let errorMessageElement = inputElement.nextElementSibling;
            // Jika input ada di dalam div .relative (misal password/select)
            if (!errorMessageElement || !errorMessageElement.classList.contains('form-error')) {
                errorMessageElement = inputElement.parentElement.nextElementSibling;
            }
            if (errorMessageElement && errorMessageElement.classList.contains('form-error')) {
                errorMessageElement.textContent = message;
                errorMessageElement.classList.remove('hidden');
            }
        }

        /**
         * Fungsi untuk menyembunyikan pesan kesalahan.
         * @param {HTMLElement} inputElemen - Elemen input yang divalidasi.
         */
        function hideValidationError(inputElement) {
            inputElement.classList.remove('is-invalid');
            let errorMessageElement = inputElement.nextElementSibling;
            if (!errorMessageElement || !errorMessageElement.classList.contains('form-error')) {
                errorMessageElement = inputElement.parentElement.nextElementSibling;
            }
            if (errorMessageElement && errorMessageElement.classList.contains('form-error')) {
                errorMessageElement.classList.add('hidden');
            }
        }

        /**
         * Melakukan validasi untuk sebuah formulir.
         * @param {HTMLFormElement} form - Formulir yang akan divalidasi.
         * @returns {boolean} - True jika validasi berhasil, False jika gagal.
         */
        function validateForm(form) {
            let isValid = true;
            const picNameRegex = /^[a-zA-Z\s]*$/;

            const requiredInputs = form.querySelectorAll('input[required], select[required]');

            requiredInputs.forEach(input => {
                hideValidationError(input); // Sembunyikan pesan error sebelumnya

                if (input.type === 'text' || input.tagName === 'SELECT' || input.type === 'password') {
                    if (!input.value.trim()) {
                        isValid = false;
                        showValidationError(input, `${input.previousElementSibling.textContent.replace('*', '').trim()} wajib diisi.`);
                    }
                }
            });

            // Validasi khusus untuk input Nama PIC
            const picNameInput = form.querySelector('input[name="pic_name"]');
            if (picNameInput && picNameInput.value.trim() && !picNameRegex.test(picNameInput.value.trim())) {
                isValid = false;
                showValidationError(picNameInput, 'Nama PIC hanya boleh mengandung huruf dan spasi.');
            }

            // Validasi khusus untuk password di form tambah
            if (form.id === 'addForm') {
                const passwordInput = form.querySelector('#password_add');
                if (passwordInput && !passwordInput.value.trim()) {
                     isValid = false;
                     showValidationError(passwordInput, 'Password wajib diisi untuk pengguna baru.');
                }
            }
            return isValid;
        }

        // Tambahkan event listener untuk submit form
        if (addForm) {
            addForm.addEventListener('submit', function(e) {
                if (!validateForm(addForm)) {
                    e.preventDefault();
                }
            });
        }

        if (editForm) {
            editForm.addEventListener('submit', function(e) {
                 if (!validateForm(editForm)) {
                    e.preventDefault();
                }
            });
        }
    });
</script>

</body>
</html>
