<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        {% if user %}
            Edit User
        {% else %}
            Management Users
        {% endif %}
    </title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* custom style untuk form select arrow, ini masih bisa di dalam <style> */
        .custom-select-arrow {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236B7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'%3e%3c/path%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
            /* -webkit-print-color-adjust: exact; */
        }

        .form-input.is-invalid {
            border-color: #ef4444 !important; /* red-500 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="container mx-auto px-4 py-8 md:py-12 max-w-4xl">
    <div class="bg-white/80 backdrop-blur-md rounded-3xl shadow-2xl p-6 md:p-10 lg:p-12 mb-8">

        <div class="flex items-center mb-6">
            <h2 class="text-indigo-600 font-bold text-3xl md:text-4xl">
                <i class="fas fa-users-cog mr-3"></i>Management Users
            </h2>
        </div>

        <div class="bg-white rounded-2xl shadow-lg border border-gray-200">
            <div class="bg-gray-800 text-white p-6 rounded-t-2xl font-bold text-xl flex items-center gap-3">
                {% if user %}
                    <i class="fas fa-user-edit"></i> Edit Pengguna
                {% else %}
                    <i class="fas fa-user-plus"></i> Tambah Pengguna Baru
                {% endif %}
            </div>
            <div class="p-6">
                <form method="POST" action="{{ url_for('add_user') }}" class="space-y-6" novalidate>
                    {% if user %}
                    <input type="hidden" name="id" value="{{ user.id }}">
                    {% endif %}
                    
                    <div>
                        <label for="username" class="block text-sm font-semibold text-gray-700 mb-2">Username</label>
                        {% if user %}
                            <input type="text" class="form-input block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50" id="username" value="{{ user.username }}" readonly>
                            <input type="hidden" name="username" value="{{ user.username }}">
                            <p class="text-xs text-gray-500 mt-1">Username tidak dapat diubah setelah dibuat.</p>
                        {% else %}
                            <input type="text" class="form-input block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50" id="username" name="username" required placeholder="Masukkan username">
                            <div class="form-error text-red-500 text-sm mt-1 hidden">Username wajib diisi.</div>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="password" class="block text-sm font-semibold text-gray-700 mb-2">Password {% if user %}(kosongkan jika tidak ingin mengubah){% else %}*{% endif %}</label>
                        <div class="relative">
                            <input type="password" class="form-input pr-12 block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50" id="password" name="password" {% if not user %}required{% endif %} placeholder="{% if user %}Biarkan kosong untuk tidak mengubah password{% else %}Masukkan password{% endif %}">
                            <span class="password-toggle absolute right-0 top-0 h-full flex items-center px-4 text-gray-500 cursor-pointer rounded-r-lg transition duration-200 hover:text-gray-700 hover:bg-gray-200" id="togglePassword">
                                <i class="fa fa-eye-slash" aria-hidden="true"></i>
                            </span>
                        </div>
                        {% if not user %}
                        <div class="form-error text-red-500 text-sm mt-1 hidden">Password wajib diisi untuk pengguna baru.</div>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="department" class="block text-sm font-semibold text-gray-700 mb-2">Bagian / Departemen</label>
                        <div class="relative">
                            <select class="form-input form-select appearance-none block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50 custom-select-arrow pr-10" id="department" name="department" required>
                                <option value="" disabled selected>-- Pilih Bagian / Departemen --</option>
                                <option value="CLF" {% if user and user.department == 'CLF' %}selected{% endif %}>CLF</option>
                                <option value="CRA" {% if user and user.department == 'CRA' %}selected{% endif %}>CRA</option>
                                <option value="CRO" {% if user and user.department == 'CRO' %}selected{% endif %}>CRO</option>
                                <option value="CRR" {% if user and user.department == 'CRR' %}selected{% endif %}>CRR</option>
                                <option value="HC" {% if user and user.department == 'HC' %}selected{% endif %}>HC</option>
                                <option value="IT" {% if user and user.department == 'IT' %}selected{% endif %}>IT</option>
                                <option value="LEGAL" {% if user and user.department == 'LEGAL' %}selected{% endif %}>LEGAL</option>
                                <option value="LGAN" {% if user and user.department == 'LGAN' %}selected{% endif %}>LGAN</option>
                                <option value="MICRO" {% if user and user.department == 'MICRO' %}selected{% endif %}>MICRO</option>
                                <option value="MES 1" {% if user and user.department == 'MES 1' %}selected{% endif %}>MES 1</option>
                                <option value="MES 2" {% if user and user.department == 'MES 2' %}selected{% endif %}>MES 2</option>
                                <option value="SECURED" {% if user and user.department == 'SECURED' %}selected{% endif %}>SECURED</option>
                                <option value="OSE" {% if user and user.department == 'OSE' %}selected{% endif %}>OSE</option>
                                <option value="RSF" {% if user and user.department == 'RSF' %}selected{% endif %}>RSF</option>
                                <option value="RFD" {% if user and user.department == 'RFD' %}selected{% endif %}>RFD</option>
                                <option value="RMC" {% if user and user.department == 'RMC' %}selected{% endif %}>RMC</option>
                                <option value="RTB" {% if user and user.department == 'RTB' %}selected{% endif %}>RTB</option>
                                <option value="RTD" {% if user and user.department == 'RTD' %}selected{% endif %}>RTD</option>
                                <option value="UNSECURED" {% if user and user.department == 'UNSECURED' %}selected{% endif %}>UNSECURED</option>
                                <option value="SMALL" {% if user and user.department == 'SMALL' %}selected{% endif %}>SMALL</option>
                                <option value="MEDIUM" {% if user and user.department == 'MEDIUM' %}selected{% endif %}>MEDIUM</option>
                                <option value="COMMERCIAL" {% if user and user.department == 'COMMERCIAL' %}selected{% endif %}>COMMERCIAL</option>
                            </select>
                            <div class="form-error text-red-500 text-sm mt-1 hidden">Bagian/Departemen wajib dipilih.</div>
                        </div>
                    </div>

                    <div>
                        <label for="picName" class="block text-sm font-semibold text-gray-700 mb-2">Nama PIC</label>
                        <input type="text" class="form-input block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50" id="picName" name="pic_name" required value="{{ user.pic_name if user else '' }}" placeholder="Masukkan nama PIC (Person In Charge)">
                        <div class="form-error text-red-500 text-sm mt-1 hidden">Nama PIC wajib diisi dan hanya boleh mengandung huruf dan spasi.</div>
                    </div>

                    <div>
                        <label for="role" class="block text-sm font-semibold text-gray-700 mb-2">Role</label>
                        <div class="relative">
                            <select class="form-input form-select appearance-none block w-full rounded-lg border-2 border-gray-300 p-3 text-gray-900 transition duration-200 focus:border-indigo-500 focus:ring-indigo-500 focus:ring-opacity-50 custom-select-arrow pr-10" id="role" name="role">
                                <option value="admin" {% if user and user.role == 'admin' %}selected{% endif %}>Admin</option>
                                <option value="user" {% if user and user.role == 'user' %}selected{% endif %}>Requester</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-full font-semibold transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg flex items-center">
                            {% if user %}
                                <i class="fas fa-save mr-2"></i> Update
                            {% else %}
                                <i class="fas fa-plus-circle mr-2"></i> Tambah
                            {% endif %}
                        </button>
                        {% if not user %}
                        <a href="{{ url_for('home') }}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-full font-semibold transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg flex items-center">
                            <i class="fas fa-arrow-left mr-2"></i> Kembali
                        </a>
                        {% else %}
                        <a href="{{ url_for('manage_users') }}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-full font-semibold transition duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg flex items-center">
                            <i class="fas fa-times-circle mr-2"></i> Batal
                        </a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% if not user %}
    <div class="bg-white/80 backdrop-blur-md rounded-3xl shadow-2xl p-6 md:p-10 lg:p-12">
        <div class="bg-gray-800 text-white p-6 rounded-t-2xl font-bold text-xl flex items-center gap-3">
            <i class="fas fa-list-alt"></i> Daftar Pengguna Sistem
        </div>
        <div class="overflow-x-auto rounded-b-2xl">
            <table class="min-w-full divide-y divide-gray-200 bg-white">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                        <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bagian / Departemen</th>
                        <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama PIC</th>
                        <th scope="col" class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                        <th scope="col" class="px-6 py-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for u in users %}
                    <tr class="hover:bg-gray-50 transition duration-150 ease-in-out">
                        <td class="px-6 py-4 whitespace-nowrap">{{ u.username }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ u.department }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ u.pic_name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">{{ u.role }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <div class="flex flex-col md:flex-row justify-center items-center gap-2"> 
                                <a href="{{ url_for('edit_user', user_id=u.id) }}" class="inline-flex items-center px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors duration-200 text-sm">
                                    <i class="fas fa-edit mr-2"></i> Edit
                                </a>
                                <a href="{{ url_for('delete_user', user_id=u.id) }}" class="inline-flex items-center px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors duration-200 text-sm" onclick="return confirm('Apakah Anda yakin ingin menghapus pengguna ini?')">
                                    <i class="fas fa-trash-alt mr-2"></i> Hapus
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center py-6 text-gray-500">
                            <i class="fas fa-inbox fa-3x mb-2"></i>
                            <p>Belum ada pengguna terdaftar.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const togglePassword = document.querySelector('#togglePassword');
        const passwordInput = document.querySelector('#password');
    
        if (togglePassword && passwordInput) {
            togglePassword.addEventListener('click', function (e) {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                this.querySelector('i').classList.toggle('fa-eye');
                this.querySelector('i').classList.toggle('fa-eye-slash');
            });
        }
    
        const form = document.querySelector('form');
        form.addEventListener('submit', function (event) {
            let isValid = true;
            
            // Validasi Nama PIC
            const picNameInput = document.getElementById('picName');
            const picNameError = picNameInput.nextElementSibling;
            const picNameRegex = /^[a-zA-Z\s]*$/;
            
            if (!picNameInput.value.trim() || !picNameRegex.test(picNameInput.value.trim())) {
                picNameInput.classList.add('is-invalid');
                picNameError.classList.remove('hidden');
                isValid = false;
            } else {
                picNameInput.classList.remove('is-invalid');
                picNameError.classList.add('hidden');
            }

            // Validasi Username (hanya untuk user baru)
            const usernameInput = document.getElementById('username');
            if (usernameInput && !usernameInput.hasAttribute('readonly') && usernameInput.value.trim() === '') {
                usernameInput.classList.add('is-invalid');
                usernameInput.nextElementSibling.classList.remove('hidden');
                isValid = false;
            } else {
                if(usernameInput && !usernameInput.hasAttribute('readonly')) {
                    usernameInput.classList.remove('is-invalid');
                    usernameInput.nextElementSibling.classList.add('hidden');
                }
            }

            // Validasi Password (hanya untuk user baru)
            const passwordInputNewUser = document.getElementById('password');
            if(passwordInputNewUser && !passwordInputNewUser.placeholder.includes('Biarkan kosong') && passwordInputNewUser.value.trim() === '') {
                passwordInputNewUser.classList.add('is-invalid');
                passwordInputNewUser.parentElement.nextElementSibling.classList.remove('hidden');
                isValid = false;
            } else {
                 if(passwordInputNewUser && !passwordInputNewUser.placeholder.includes('Biarkan kosong')) {
                    passwordInputNewUser.classList.remove('is-invalid');
                    passwordInputNewUser.parentElement.nextElementSibling.classList.add('hidden');
                }
            }
            
            // Validasi Department
            const departmentInput = document.getElementById('department');
            const departmentError = departmentInput.nextElementSibling;
            if (departmentInput.value === '') {
                departmentInput.classList.add('is-invalid');
                departmentError.classList.remove('hidden');
                isValid = false;
            } else {
                departmentInput.classList.remove('is-invalid');
                departmentError.classList.add('hidden');
            }

            if (!isValid) {
                event.preventDefault();
            }
        });
    });
</script>

</body>
</html>